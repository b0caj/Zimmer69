<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Buzzer</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="custom-form.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Online Buzzer Raum</h1>
        
        <form id="login-form">
            <div id="name-input-container">
                <label for="name-input">Nutzername:</label>
                <input type="text" id="name-input" placeholder="Gib deinen Namen ein">
                
                <label for="password-input">Passwort:</label>
                <input type="password" id="password-input" placeholder="Gib dein Passwort ein">

                <button id="login-button" type="submit">Login</button>
            </div>
        </form>
        
        <div id="main-content" style="display: none;">
            <div id="scoreboard-container" class="column">
                <div id="scoreboard">
                    <h2>Punkte</h2>
                    <ul id="score-list"></ul>
                </div>
            </div>
            
            <div id="player-controls" class="column">
                <div id="player-info">
                    <h3>Willkommen, <span id="player-name"></span>!</h3>
                    <p id="question-text">Frage wird vom Host geladen...</p>
                    <p id="status-message">Der Buzzer ist geschlossen.</p>
                </div>
                
                <button id="buzzer-button" disabled>Buzz!</button>
                
                <div id="answer-section" style="display: none;">
                    <label for="answer-input">Deine Antwort:</label>
                    <input type="text" id="answer-input" placeholder="Antwort eingeben...">
                    <button id="submit-answer-button">Antwort senden</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="buzz-sound" src="buzz.mp3" preload="auto"></audio>
    <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
    <audio id="wrong-sound" src="wrong.mp3" preload="auto"></audio>

    <script>
        const ws = new WebSocket(`wss://${window.location.host}`);
        
        const loginForm = document.getElementById('login-form');
        const nameInput = document.getElementById('name-input');
        const passwordInput = document.getElementById('password-input');
        const mainContent = document.getElementById('main-content');
        
        const buzzerButton = document.getElementById('buzzer-button');
        const statusMessage = document.getElementById('status-message');
        const playerNameSpan = document.getElementById('player-name');
        const scoreList = document.getElementById('score-list');
        const questionText = document.getElementById('question-text');
        
        const buzzSound = document.getElementById('buzz-sound');
        const correctSound = document.getElementById('correct-sound');
        const wrongSound = document.getElementById('wrong-sound');
        
        const answerSection = document.getElementById('answer-section');
        const answerInput = document.getElementById('answer-input');
        const submitAnswerButton = document.getElementById('submit-answer-button');

        let isHost = false;

        function playSound(sound) {
            sound.currentTime = 0;
            sound.play();
        }

        loginForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const name = nameInput.value;
            const password = passwordInput.value;
            if (name && password) {
                ws.send(JSON.stringify({ type: 'auth', name, password }));
            }
        });

        buzzerButton.addEventListener('click', () => {
            ws.send(JSON.stringify({ type: 'buzz', name: nameInput.value }));
            playSound(buzzSound);
        });
        
        submitAnswerButton.addEventListener('click', () => {
            const answer = answerInput.value;
            if (answer) {
                ws.send(JSON.stringify({ type: 'submitAnswer', name: nameInput.value, answer: answer }));
                answerInput.value = '';
                submitAnswerButton.disabled = true;
                answerInput.disabled = true;
            }
        });

        function renderScores(scores, activePlayers) {
            scoreList.innerHTML = '';
            for (const name in scores) {
                const li = document.createElement('li');
                li.textContent = `${name}: ${scores[name]}`;
                if (activePlayers.includes(name)) {
                    li.classList.add('active-player');
                }
                scoreList.appendChild(li);
            }
        }
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === 'loginSuccess') {
                if (data.isHost) {
                    window.location.href = '/quizmaster.html';
                } else {
                    document.getElementById('login-form').style.display = 'none';
                    mainContent.style.display = 'flex';
                    playerNameSpan.textContent = nameInput.value;
                    isHost = data.isHost;
                }
            }
            
            if (data.type === 'loginFailure') {
                alert('Login fehlgeschlagen. Überprüfen Sie Ihren Namen und Ihr Passwort.');
            }

            if (data.type === 'updateStatus') {
                if (data.status === 'open') {
                    statusMessage.textContent = 'Buzzer ist offen! Sei schnell!';
                    buzzerButton.disabled = false;
                    answerSection.style.display = 'none'; // Verstecke den Antwortbereich, wenn der Buzzer offen ist
                } else if (data.buzzedIn) {
                    if (data.buzzedIn === nameInput.value) {
                        statusMessage.textContent = 'Du hast zuerst gebuzzt!';
                        answerSection.style.display = 'block';
                        answerInput.disabled = false;
                        submitAnswerButton.disabled = false;
                    } else {
                        statusMessage.textContent = `${data.buzzedIn} hat zuerst gebuzzt!`;
                        answerSection.style.display = 'none';
                    }
                    buzzerButton.disabled = true;
                } else {
                    statusMessage.textContent = 'Der Buzzer ist geschlossen.';
                    buzzerButton.disabled = true;
                    answerSection.style.display = 'none';
                }
            }
            
            if (data.type === 'updateQuestion') {
                questionText.textContent = data.question;
            }
            
            if (data.type === 'updateScores') {
                renderScores(data.scores, data.activePlayers);
            }
            
            if (data.type === 'correctAnswer') {
                statusMessage.textContent = `${data.name} war korrekt!`;
                playSound(correctSound);
            }
            
            if (data.type === 'wrongAnswer') {
                statusMessage.textContent = `${data.name} war falsch.`;
                playSound(wrongSound);
            }
        };

        ws.onclose = () => {
            console.log('Verbindung getrennt.');
        };
    </script>
</body>
</html>