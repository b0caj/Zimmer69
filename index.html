<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Buzzer</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="custom-form.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Online Buzzer Raum</h1>
        
        <form id="login-form">
            <div id="name-input-container">
                <label for="name-input">Nutzername:</label>
                <input type="text" id="name-input" placeholder="Gib deinen Namen ein">
                
                <label for="password-input">Passwort:</label>
                <input type="password" id="password-input" placeholder="Gib dein Passwort ein">

                <button id="login-button" type="submit">Login</button>
            </div>
        </form>
        
        <div id="main-content" style="display: none;">
            <div id="scoreboard-container" class="column">
                <div id="scoreboard">
                    <h2>Punkte</h2>
                    <ul id="score-list"></ul>
                </div>
            </div>
            
            <div id="buzzer-container" class="column">
                <div id="question-area">
                    <p id="question-text"></p>
                </div>
                <button id="buzzer-button" disabled>Buzz</button>
                <p id="status-message">Gib deinen Namen ein, um zu starten.</p>
                <div id="answer-section" style="display:none;">
                    <input type="text" id="answer-input" placeholder="Deine Antwort...">
                    <button id="submit-answer-button" disabled>Senden</button>
                </div>
            </div>
        </div>
    </div>
    <audio id="buzz-sound" src="buzz.mp3" preload="auto"></audio>
    <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
    <audio id="wrong-sound" src="wrong.mp3" preload="auto"></audio>
    
    <script>
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const nameInput = document.getElementById('name-input');
        const passwordInput = document.getElementById('password-input');
        const mainContent = document.getElementById('main-content');
        const buzzerButton = document.getElementById('buzzer-button');
        const statusMessage = document.getElementById('status-message');
        const scoreList = document.getElementById('score-list');
        const questionText = document.getElementById('question-text');
        const answerSection = document.getElementById('answer-section');
        const answerInput = document.getElementById('answer-input');
        const submitAnswerButton = document.getElementById('submit-answer-button');
        const buzzSound = document.getElementById('buzz-sound');
        const correctSound = document.getElementById('correct-sound');
        const wrongSound = document.getElementById('wrong-sound');

        const ws = new WebSocket(`wss://${window.location.host}`);

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = nameInput.value;
            const password = passwordInput.value;
            if (name) {
                ws.send(JSON.stringify({
                    type: 'login',
                    name: name,
                    password: password
                }));
            }
        });

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === 'loginSuccess') {
                if (data.isHost) {
                    // Speichere den SitzungsschlÃ¼ssel, um ihn auf der Quizmaster-Seite zu verwenden
                    localStorage.setItem('hostSessionId', data.hostSessionId);
                    // Leite zum Quizmaster-Panel weiter
                    window.location.href = '/quizmaster.html';
                } else {
                    loginForm.style.display = 'none';
                    mainContent.style.display = 'flex';
                    statusMessage.textContent = 'Bereit zu buzzern!';
                    console.log(`Verbunden als ${nameInput.value}`);
                }
            }

            if (data.type === 'updateStatus') {
                if (data.status === 'open') {
                    statusMessage.textContent = 'Buzzer ist offen! Buzze schnell!';
                    buzzerButton.disabled = false;
                    answerSection.style.display = 'none';
                } else if (data.status === 'closed') {
                    statusMessage.textContent = 'Der Buzzer ist geschlossen.';
                    buzzerButton.disabled = true;
                }
            }
            
            if (data.type === 'buzzerResponse') {
                statusMessage.textContent = `${nameInput.value}, du hast zuerst gebuzzt!`;
                buzzerButton.disabled = true;
                answerSection.style.display = 'block';
                answerInput.disabled = false;
                submitAnswerButton.disabled = false;
                buzzSound.play();
            }
            
            if (data.type === 'updateQuestion') {
                questionText.textContent = data.question;
            }
            
            if (data.type === 'updateScores') {
                renderScores(data.scores, data.activePlayers);
            }
            
            if (data.type === 'correctAnswer') {
                statusMessage.textContent = `${data.name} war korrekt!`;
                playSound(correctSound);
            }
            
            if (data.type === 'wrongAnswer') {
                statusMessage.textContent = `${data.name} war falsch.`;
                playSound(wrongSound);
            }
        };

        ws.onclose = () => {
            console.log('Verbindung getrennt.');
        };
        
        buzzerButton.addEventListener('click', () => {
            ws.send(JSON.stringify({ type: 'buzz' }));
        });
        
        submitAnswerButton.addEventListener('click', () => {
            const answer = answerInput.value;
            if (answer) {
                ws.send(JSON.stringify({
                    type: 'submitAnswer',
                    answer: answer
                }));
            }
        });

        function renderScores(scores, activePlayers) {
            scoreList.innerHTML = '';
            scores.sort((a, b) => b.totalScore - a.totalScore);
            scores.forEach(player => {
                const li = document.createElement('li');
                if (activePlayers.includes(player.name)) {
                    li.innerHTML = `<strong>${player.name}</strong>: ${player.totalScore} Punkte`;
                } else {
                    li.innerHTML = `${player.name}: ${player.totalScore} Punkte`;
                }
                scoreList.appendChild(li);
            });
        }
        
        function playSound(soundElement) {
            soundElement.currentTime = 0;
            soundElement.play();
        }
    </script>
</body>
</html>