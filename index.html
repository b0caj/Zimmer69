<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Buzzer</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="custom-form.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Online Buzzer Raum</h1>
        
        <form id="login-form">
            <div id="name-input-container">
                <label for="name-input">Nutzername:</label>
                <input type="text" id="name-input" placeholder="Gib deinen Namen ein">
                
                <label for="password-input">Passwort:</label>
                <input type="password" id="password-input" placeholder="Gib dein Passwort ein">

                <button id="login-button" type="submit">Login</button>
            </div>
        </form>
        
        <div id="main-content" style="display: none;">
            <div id="scoreboard-container" class="column">
                <div id="scoreboard">
                    <h2>Punkte</h2>
                    <ul id="score-list"></ul>
                </div>
            </div>
            
            <div id="buzzer-container" class="column">
                <div id="question-area">
                    <p id="question-text"></p>
                </div>
                <button id="buzzer-button" disabled>Buzz</button>
                <p id="status-message">Gib deinen Namen ein, um zu starten.</p>
                <div id="answer-section" style="display:none;">
                    <input type="text" id="answer-input" placeholder="Deine Antwort...">
                    <button id="submit-answer-button" disabled>Senden</button>
                </div>
            </div>
        </div>
    </div>
    <audio id="buzz-sound" src="buzz.mp3" preload="auto"></audio>
    <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
    <audio id="wrong-sound" src="wrong.mp3" preload="auto"></audio>
    
<script>
    const loginForm = document.getElementById('login-form');
    const nameInput = document.getElementById('name-input');
    const passwordInput = document.getElementById('password-input');
    const mainContent = document.getElementById('main-content');
    const buzzerButton = document.getElementById('buzzer-button');
    const statusMessage = document.getElementById('status-message');
    const questionText = document.getElementById('current-question');
    const scoreList = document.getElementById('score-list');
    const answerSection = document.getElementById('answer-section');
    const answerInput = document.getElementById('answer-input');
    const submitAnswerButton = document.getElementById('submit-answer-button');

    const correctSound = new Audio('correct.mp3');
    const wrongSound = new Audio('wrong.mp3');
    
    // WebSocket-Verbindung
    let ws;
    
    // Funktion zum Verbinden mit dem WebSocket-Server
    function connectToServer(hostToken) {
        let url = `wss://${window.location.host}`;
        if (hostToken) {
            url += `?hostToken=${hostToken}`;
        }
        ws = new WebSocket(url);

        ws.onopen = () => {
            console.log('Mit dem WebSocket-Server verbunden.');
            if (hostToken) {
                // Host-Verbindung ist über Token bereits authentifiziert
                window.location.href = 'quizmaster.html';
            }
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === 'loginSuccess') {
                if (data.isHost) {
                    // Speichern Sie die Sitzungs-ID im localStorage, um die Host-Verbindung aufrechtzuerhalten
                    localStorage.setItem('hostSessionId', data.sessionId);
                    window.location.href = 'quizmaster.html';
                } else {
                    document.getElementById('login-form').style.display = 'none';
                    mainContent.style.display = 'flex';
                }
            }
            
            if (data.type === 'buzzerStatus') {
                buzzerButton.disabled = data.status === 'closed';
                if (data.status === 'closed') {
                    statusMessage.textContent = 'Der Buzzer ist geschlossen.';
                } else {
                    statusMessage.textContent = 'Der Buzzer ist geöffnet!';
                }
            }
            
            if (data.type === 'buzzedIn') {
                statusMessage.textContent = `${data.buzzedIn} hat zuerst gebuzzt!`;
                buzzerButton.disabled = true;
                answerSection.style.display = 'none';
                if (data.buzzedIn === nameInput.value) {
                   answerSection.style.display = 'block';
                   answerInput.disabled = false;
                   submitAnswerButton.disabled = false;
                }
            }
            
            if (data.type === 'updateQuestion') {
                questionText.textContent = data.question;
            }
            
            if (data.type === 'updateScores') {
                renderScores(data.scores, data.activePlayers);
            }
            
            if (data.type === 'correctAnswer') {
                statusMessage.textContent = `${data.name} war korrekt!`;
                playSound(correctSound);
            }
            
            if (data.type === 'wrongAnswer') {
                statusMessage.textContent = `${data.name} war falsch.`;
                playSound(wrongSound);
            }
        };
        
        ws.onclose = () => {
            console.log('Verbindung getrennt.');
            setTimeout(() => {
                const hostToken = localStorage.getItem('hostSessionId');
                if (hostToken) {
                    connectToServer(hostToken);
                } else {
                    connectToServer();
                }
            }, 5000); // 5 Sekunden warten und erneut versuchen
        };
    }
    
    function renderScores(scores, activePlayers) {
        scoreList.innerHTML = '';
        const sortedPlayers = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        sortedPlayers.forEach(([name, score]) => {
            const listItem = document.createElement('li');
            listItem.textContent = `${name}: ${score} Punkte`;
            if (activePlayers.includes(name)) {
                listItem.classList.add('active-player');
            }
            scoreList.appendChild(listItem);
        });
    }

    function playSound(sound) {
        sound.pause();
        sound.currentTime = 0;
        sound.play();
    }
    
    loginForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const name = nameInput.value.trim();
        const password = passwordInput.value.trim();
        
        if (name) {
            ws.send(JSON.stringify({ type: 'login', name, password }));
        }
    });

    buzzerButton.addEventListener('click', () => {
        ws.send(JSON.stringify({ type: 'buzz' }));
    });

    submitAnswerButton.addEventListener('click', () => {
        const answer = answerInput.value.trim();
        if (answer) {
            ws.send(JSON.stringify({ type: 'submitAnswer', answer }));
            answerInput.value = '';
        }
    });
    
    // Versuchen Sie, die Host-Sitzung aus dem lokalen Speicher zu laden und eine Verbindung herzustellen
    const hostToken = localStorage.getItem('hostSessionId');
    connectToServer(hostToken);

</script>
</body>
</html>